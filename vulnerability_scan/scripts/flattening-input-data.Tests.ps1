# Import the Pester module
Import-Module Pester

# Define the path to the script
$scriptPath = './flattening-input-data.ps1'

# Define the path to the directories
$rawFlatternedDir = './data/raw_flatterned'
$scannedSbomsDir = './artifacts/scanned_sboms'

Describe 'Flattening Input Data Tests' {
    BeforeAll {
        # Run the script
        & $scriptPath
    }

    It 'Creates the raw_flatterned directory' {
        # Check if the directory exists
        Test-Path $rawFlatternedDir | Should -BeTrue
    }

    It 'Creates the scanned_sboms directory' {
        # Check if the directory exists
        Test-Path $scannedSbomsDir | Should -BeTrue
    }

    It 'Processes the files' {
        # Check if the files have been processed
        foreach ($fileName in (Get-ChildItem -Path $rawFlatternedDir)) {
            $fileContent = Get-Content -Path "$rawFlatternedDir/$fileName" | ConvertFrom-Json
            $fileContent.packages.name | Should -Not -BeNullOrEmpty
        }
    }
}