#!/usr/bin/env pwsh

$here = Split-Path -Parent $PSCommandPath
$here = Split-Path -Parent $here

$sourceDir = "$here/data/raw"  
$targetDir = "$here/data/raw_flatterned"  

Write-Host $targetDir

if (-not (Test-Path $targetDir -PathType Container)) {
    New-Item -ItemType Directory -Force -Path $targetDir
}

$jsonFiles = Get-ChildItem -Path $sourceDir -Filter *.json -Recurse

foreach ($file in $jsonFiles) {
    Copy-Item -Path $file.FullName -Destination $targetDir
}

$subDirs = Get-ChildItem -Path $targetDir -Directory

foreach ($dir in $subDirs) {
    Remove-Item -Path $dir.FullName -Recurse -Force
}

$flatternedDirFiles = Get-ChildItem -Path $targetDir -Filter *.json

$fileNames = @()

foreach ($file in $flatternedDirFiles){
    dotnet-covenant convert spdx $file.FullName -o $file.FullName
    $fileNames += $file.name
    Write-Output $file.FullName
    Write-Host "Converted $file to SPDX"
}

$fileNames | ConvertTo-Json | Out-File "$here/artifacts/list_of_files.json"

bomber scan $here/data/raw_flatterned/ --output=json > $here/artifacts/results.json

